/*
 Victor Ribeiro 2018
 @license MIT
 @requires assets/libs/clusterize/clusterize.min.js
 @requires assets/libs/cryptojs/crypto-aes.min.js
 @requires assets/libs/instascan/instascan.compressed.js
 @requires assets/libs/jquery/jquery.min.js
 @requires assets/libs/materialize/js/materialize.min.js
 @todo Documentate this
*/
scanner={};
var logIsEnabled,snapTimeout,toastTimeout,cameraGlobal,actualLiArr,actualScrollEl,actualContentEl,isCameraTabActive=!0,saved_li_arr=[],rejected_li_arr=[],syncArr=[],_cza="ti2",_cyb="sp",_cxb="ro",_cx="p"+_cxb,_cz=_cza+"01",_cy="pe"+_cyb,_k=_cx+_cy+_cz+"3",qrScan={data:[],rejected:[],LOADING:document.querySelector(".pp-scanner--status__loading"),sortNumber:function(a,b){return a-b},initHtmlElement:function(a){return document.getElementById(a)},initVideoObjectOptions:function(a){scanner={};return{video:qrScan.initHtmlElement(a),
continuous:!0,mirror:!1,captureImage:!1,backgroundScan:!1,refractoryPeriod:4E3,scanPeriod:5}},initAvaliableCameras:function(a){Instascan.Camera.getCameras().then(function(b){a()})},initCamera:function(a){scanner.stop();Instascan.Camera.getCameras().then(function(a){if(0<a.length){var b=a[0];$.each(a,function(a,c){if(-1!==c.name.indexOf("back"))return b=c,!1});scanner.start(b);cameraGlobal=b}else alert("Nenhuma camera encontrada.")})},scanStart:function(a){scanner.addListener("scan",function(b){a(b)})},
saveScannedData:function(a){var b;null===a.match(/(\n|\s|\{|\()/g)&&(b=CryptoJS.AES.decrypt(a,_k),full_dec=b.toString(CryptoJS.enc.Utf8),b=(b=""!==a&&""===full_dec?!1:null!==full_dec.match(/^\{(.*)\}/g)?!0:!1)?null!==full_dec.match(/^\x7b\"\x70\x72\x6f\x70\x65\x73\x70\"\:\x7b(.*)\x7d\x7d/g)?!0:!1:!1);b?(qrScan.animate._snap(),qrScan.animate._success(),qrScan.data.push(JSON.parse(full_dec)),a=JSON.stringify(qrScan.data),a=CryptoJS.AES.encrypt(a,_k),qrScan.dataRaw=a.toString(),localStorage.setItem("data",
a),qrScan.animate._showToast("Dados salvos!",2E3),qrScan.updateHTMLArray("data"),qrScan.updateCluster(saved_li_arr)):(qrScan.animate._snap(),qrScan.animate._error(),qrScan.rejected.push(a),a=JSON.stringify(qrScan.rejected),a=CryptoJS.AES.encrypt(a,_k),qrScan.rejectedRaw=a.toString(),localStorage.setItem("rejected",a),qrScan.animate._showToast("QR Code inv\u00e1lido!",2E3),qrScan.updateHTMLArray("rejected"),qrScan.updateCluster(rejected_li_arr))},loadFromLS:function(a){if("data"===a){var b=localStorage.getItem(a),
c=CryptoJS.AES.decrypt(b,_k).toString(CryptoJS.enc.Utf8);qrScan.data=null===b?qrScan.data:JSON.parse(c);qrScan.dataRaw=b}"rejected"===a&&(a=localStorage.getItem(a),b=CryptoJS.AES.decrypt(a,_k).toString(CryptoJS.enc.Utf8),qrScan.rejected=null===localStorage.getItem("rejected")?qrScan.rejected:JSON.parse(b),qrScan.rejectedRaw=a)},updateHTMLArray:function(a){if("data"===a||void 0===a){saved_li_arr=[];for(var b=qrScan.data.length,c=0;c<b;c++)saved_li_arr.push('<li class="collection-item avatar  valign-wrapper" data-id="'+
qrScan.data[c][x].id+'"><i class="material-icons circle green">done</i><span class="title">'+qrScan.data[c][x].nome+"</span></li>")}if("rejected"===a||void 0===a)for(rejected_li_arr=[],a=qrScan.rejected.length,b=0;b<a;b++)rejected_li_arr.push('<li class="collection-item avatar"><i class="material-icons circle">close</i><span class="title">'+qrScan.rejected[b]+"</span></li>")},reload:function(){document.location.reload()},clearSaved:function(){localStorage.removeItem("data");qrScan.data=[];saved_li_arr=
[];qrScan.updateHTMLArray("data");qrScan.updateCluster(saved_li_arr);qrScan.animate._showToast("Lista de dados salvos apagada!",2E3)},clearRejected:function(){localStorage.removeItem("rejected");qrScan.rejected=[];rejected_li_arr=[];qrScan.updateHTMLArray("rejected");qrScan.updateCluster(rejected_li_arr);qrScan.animate._showToast("Lista de rejeitados apagada!",2E3)},saveToFile:function(a,b,c){var d=document.createElement("a");a=new Blob([a],{type:c});d.href=URL.createObjectURL(a);d.download=b;d.click()},
saveJSON:function(){var a=new Date,b=a.getDate(),c=a.getMonth()+1,d=a.getFullYear(),e=a.getHours(),a=a.getMinutes();qrScan.saveToFile(qrScan.dataRaw,"propespqr--"+b+"-"+c+"-"+d+"-"+e+"-"+a+".p","text/plain")},initScanner:function(a){scanner=new Instascan.Scanner(a)},animate:{_snap:function(){document.querySelector(".pp-scanner--status .pp-scanner--status__snap").classList.remove("snap-anim");$(".pp-scanner--status .pp-scanner--status__snap").addClass("snap-anim").one("webkitAnimationEnd oanimationend msAnimationEnd animationend",
function(a){document.querySelector(".pp-scanner--status .pp-scanner--status__snap").classList.remove("snap-anim")})},_showToast:function(a,b){void 0==b&&(b=5E3);M.Toast.dismissAll();M.toast({html:a,displayLength:b})},_success:function(){var a=document.querySelector(".pp-scanner--status__success");document.querySelector(".pp-scanner--status__error").classList.remove("snap-status-in","snap-status-out");void 0!==snapTimeout&&clearTimeout(snapTimeout);a.classList.remove("snap-status-in","snap-status-out");
a.classList.add("snap-status-in");snapTimeout=setTimeout(function(){$(a).removeClass("snap-status-in").addClass("snap-status-out").one("webkitAnimationEnd oanimationend msAnimationEnd animationend",function(b){a.classList.remove("snap-status-out")})},3E3)},_error:function(){var a=document.querySelector(".pp-scanner--status__success"),b=document.querySelector(".pp-scanner--status__error");a.classList.remove("snap-status-in","snap-status-out");void 0!==snapTimeout&&clearTimeout(snapTimeout);b.classList.remove("snap-status-in",
"snap-status-out");b.classList.add("snap-status-in");snapTimeout=setTimeout(function(){$(b).removeClass("snap-status-in").addClass("snap-status-out").one("webkitAnimationEnd oanimationend msAnimationEnd animationend",function(a){b.classList.remove("snap-status-out")})},3E3)},_loading:function(a){a?qrScan.LOADING.classList.remove("transparent"):qrScan.LOADING.classList.add("transparent")},_pageLoaded:function(){document.querySelector(".pp-loading-page").style.display="none"}},newClusterize:function(){clusterize=
new Clusterize({rows:actualLiArr,tag:"ul",scrollId:actualScrollId,contentId:actualContentId,no_data_text:"Nenhum bolsista"})},updateCluster:function(a){clusterize.update(a)},clearHTML:function(a){document.getElementById(a).innerHTML=""}},clusterize=new Clusterize({rows:saved_li_arr,tag:"ul",scrollId:"pp-scanned-list__cluster-scroll--saved",contentId:"pp-scanned-list__cluster-content--saved",no_data_text:"Nenhum bolsista",callbacks:{clusterChanged:function(){}}});
null!==localStorage.getItem("data")&&(qrScan.loadFromLS("data"),qrScan.updateHTMLArray("data"));null!==localStorage.getItem("rejected")&&(qrScan.loadFromLS("rejected"),qrScan.updateHTMLArray("rejected"));var options={},options=qrScan.initVideoObjectOptions("pp-scanner--camera"),cameraId=0;qrScan.initScanner(options);qrScan.initAvaliableCameras(function(){cameraId=1});qrScan.initCamera(cameraId);qrScan.scanStart(function(a){qrScan.saveScannedData(a)});scanner.addListener("active",function(){qrScan.animate._loading(!1)});
scanner.addListener("inactive",function(){qrScan.animate._loading(!0)});$(".dropdown-trigger").dropdown({constrainWidth:!1,inDuration:300,outDuration:300});
$(".tabs").tabs({swipeable:!0,duration:200,onShow:function(){var a=document.querySelector('a[href="#scroll-tab-1"]').classList.contains("active"),b=document.querySelector('a[href="#scroll-tab-2"]').classList.contains("active"),c=document.querySelector('a[href="#scroll-tab-3"]').classList.contains("active"),d=document.getElementById("pp-scanned-list__cluster-content--saved"),e=document.getElementById("pp-scanned-list__cluster-content--rejected");a&&!isCameraTabActive?(actualLiArr=actualContentId=actualScrollId=
void 0,isCameraTabActive=!0,setTimeout(function(){scanner.start(cameraGlobal)},1500)):!a&&isCameraTabActive&&(isCameraTabActive=!1,scanner.stop());b?(actualScrollId="pp-scanned-list__cluster-scroll--saved",actualContentId="pp-scanned-list__cluster-content--saved",actualLiArr=saved_li_arr,qrScan.newClusterize(),d.scrollTop=d.scrollHeight):c&&(actualScrollId="pp-scanned-list__cluster-scroll--rejected",actualContentId="pp-scanned-list__cluster-content--rejected",actualLiArr=rejected_li_arr,qrScan.newClusterize(),
e.scrollTop=e.scrollHeight)}});
